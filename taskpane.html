<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <title>Unsubscribe Tool</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <script src="commands.js"></script>
  <style>
    body {
      font-family: Segoe UI, sans-serif;
      padding: 20px;
      background: #fff;
    }
    h3 {
      color: #c00;
      margin-bottom: 8px;
    }
    p {
      font-size: 13px;
      color: #333;
      margin-bottom: 16px;
    }
    #senderInfo {
      font-size: 12px;
      color: #555;
      margin-bottom: 16px;
      padding: 8px;
      background: #f5f5f5;
      border-left: 3px solid #c00;
    }
    button {
      background-color: #c00;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      border-radius: 3px;
    }
    button:hover {
      background-color: #900;
    }
    #status {
      margin-top: 12px;
      font-size: 12px;
      color: #333;
    }
  </style>
</head>
<body>
  <h3>Unsubscribe Tool</h3>
  <div id="senderInfo">Loading email info...</div>
  <p>This will send an unsubscribe reply and delete the original email.</p>
  <button onclick="sendUnsubscribe()">Send Unsubscribe &amp; Delete</button>
  <div id="status"></div>

  <script>
    Office.onReady(function() {
      // Display sender info when panel opens
      var item = Office.context.mailbox.item;
      var info = "FROM: " + item.from.displayName + "<br>EMAIL: " + item.from.emailAddress + "<br>SUBJECT: " + item.subject;
      document.getElementById("senderInfo").innerHTML = info;
    });

    function sendUnsubscribe() {
      var item = Office.context.mailbox.item;
      var senderEmail = item.from.emailAddress;
      var status = document.getElementById("status");

      status.innerText = "Sending...";

      // Create the reply message via EWS
      Office.context.mailbox.item.displayReplyForm({
        htmlBody: "<p>Unsubscribe</p>"
      });

      // Use makeEwsRequestAsync to send the reply and delete
      var ewsRequest =
        '<?xml version="1.0" encoding="utf-8"?>' +
        '<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" ' +
        '  xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types">' +
        '  <soap:Body>' +
        '    <CreateItem MessageDisposition="SendAndSaveCopy" ' +
        '      xmlns="http://schemas.microsoft.com/exchange/services/2006/messages">' +
        '      <SavedItemFolderId>' +
        '        <t:DistinguishedFolderId Id="sentitems"/>' +
        '      </SavedItemFolderId>' +
        '      <Items>' +
        '        <t:Message>' +
        '          <t:Subject>Unsubscribe</t:Subject>' +
        '          <t:Body BodyType="Text">Unsubscribe</t:Body>' +
        '          <t:ToRecipients>' +
        '            <t:Mailbox><t:EmailAddress>' + senderEmail + '</t:EmailAddress></t:Mailbox>' +
        '          </t:ToRecipients>' +
        '        </t:Message>' +
        '      </Items>' +
        '    </CreateItem>' +
        '  </soap:Body>' +
        '</soap:Envelope>';

      Office.context.mailbox.makeEwsRequestAsync(ewsRequest, function(result) {
        if (result.status === Office.AsyncResultStatus.Succeeded) {
          // Now delete the original email
          Office.context.mailbox.item.moveToAsync(
            Office.MailboxEnums.WellKnownFolderName.DeletedItems,
            function(moveResult) {
              if (moveResult.status === Office.AsyncResultStatus.Succeeded) {
                status.innerText = "Done. Reply sent and email deleted.";
              } else {
                status.innerText = "Reply sent. Could not delete: " + moveResult.error.message;
              }
            }
          );
        } else {
          status.innerText = "Error sending reply: " + result.error.message;
        }
      });
    }
  </script>
</body>
</html>